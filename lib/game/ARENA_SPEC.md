# Спецификация арены (Arena) — поле боя в стиле Clash Royale

Арена для дуэльной аркадной стратегии: симметричная сетка, река по центру, две линии (мосты). Чистый, «игрушечный» фэнтези-стиль без копирования оригинальных ассетов.

---

## 1. Сетка и метрика

| Параметр | Значение |
|----------|----------|
| Ширина (X) | 18 клеток (0…17) |
| Длина (Y) | 32 клетки (0…31) |
| Всего клеток | 576 |
| **CELL_SIZE_PX** | 20 (масштаб, хитбоксы, клики) |
| **PLACEMENT_BUFFER_CELLS** | 0 (здания вплотную) |

### Системы координат

**Логическая (по спецификации):**
- (0, 0) — левый нижний угол (сторона игрока).
- X растёт вправо, **Y растёт вверх**.
- Игрок: Y ∈ [0 … RIVER_START−1]. Противник: Y ∈ [RIVER_END+1 … 31].

**Экранная (движок/канвас):**
- (0, 0) — левый верхний угол.
- Row 0 = верх (сторона противника), row 31 = низ (игрок).
- Связь: `logicalY = 31 - screenRow`, `screenRow = 31 - logicalY`.

У каждого объекта есть:
- **Grid**: (cellX, cellY)
- **World**: (pixelX, pixelY) = центр клетки в пикселях (через `cellToWorld`).

Сетка в игре может не рисоваться; в отладке доступны: сетка, подсветка размещения, проходимость (walkable/non-walkable).

---

## 2. Структура поля: две половины + река

| Зона | Условие по Y (логич.) | Условие по row (экран) |
|------|------------------------|------------------------|
| Игрок (низ) | Y ∈ [0 … RIVER_START−1] | row ∈ [17 … 31] |
| Река | Y ∈ [RIVER_START … RIVER_END] | row ∈ [15 … 16] |
| Противник (верх) | Y ∈ [RIVER_END+1 … 31] | row ∈ [0 … 14] |

**Параметры реки:**
- **RIVER_START** = 15, **RIVER_END** = 16 (толщина 2 ряда).
- Вода: непроходима, нельзя размещать (кроме мостов).

Поле зеркально симметрично относительно горизонтальной оси по центру.

---

## 3. Мосты (переправы)

- **Количество:** 2 (левый и правый).
- **Размер:** 2×2 клетки (ширина × высота по реке).
- **Позиции (экранные row/col):**
  - Левый мост: X ∈ [4, 5], Y (row) ∈ [RIVER_START … RIVER_END].
  - Правый мост: X ∈ [12, 13], Y ∈ [RIVER_START … RIVER_END].

Для клеток моста:
- **tileType** = BRIDGE
- **walkable** = true
- **placeable** = false (войска/здания на мостах не ставятся).

Визуально: отдельный слой над водой, контраст к воде, тень/обводка.

---

## 4. Типы клеток (tile types)

| Тип | walkable | placeable | Использование |
|-----|----------|-----------|----------------|
| **GROUND** | ✓ | ✓ | Земля на обеих половинах |
| **WATER** | ✗ | ✗ | Река |
| **BRIDGE** | ✓ | ✗ | Мосты |
| **BLOCKED** / STRUCTURE_PAD | ✗ | ✗ | Площадки под башни, декор-барьеры |

Единый справочник: `TILE`, `getTileFlags()` в `arena.ts`.

---

## 5. Зоны размещения (deployment)

- **Войска (troops):** только на своей половине; запрещено: вода, мосты, BLOCKED, занятые клетки.
- **Здания (buildings):** только на своей половине; проверка по **footprint** (все клетки footprint должны быть валидны).
- **Спеллы:** привязки к клеткам нет; можно целиться в любую точку арены; прицел можно «магнитить» к центрам клеток по желанию.

Проверки: `canPlaceTroop()`, `canPlaceBuilding()` в `arena.ts`.

---

## 6. Footprint зданий и коллизии

- **Стандарт:** 3×3 клетки (все 9 должны быть в границах, на своей половине, placeable, не заняты).
- **Исключения 2×2:** тесла, пушечная тележка и т.п.
- **Якорь:** верхний левый угол footprint; размещение задаёт (cellX, cellY) как top-left.
- **Буфер:** PLACEMENT_BUFFER_CELLS = 0 — здания можно ставить вплотную.

Константы: `FOOTPRINT.LARGE` (3×3), `FOOTPRINT.SMALL` (2×2). Вспомогательные: `getFootprintCells()`, `canPlaceBuilding()`.

---

## 7. Пути и движение

- Река непроходима кроме мостов; путь на сторону противника идёт только через мосты.
- Локально: юниты ходят по walkable; обходят BLOCKED и footprint зданий.
- Поставленное здание сразу помечает свой footprint как непроходимый для pathfinding.

В движке используется A* по сетке (0=walkable, 1=blocked, 2=river, 3=bridge); мосты и земля — проходимы.

---

## 8. Визуальные слои (layering)

1. Background / base terrain  
2. Lane ground (земля полос)  
3. River water (вода, анимация flow/shimmer)  
4. Bridges (над водой)  
5. Decor (по краям, не мешая клеткам)  
6. Gameplay overlay: подсветка размещения (зелёный/красный), footprint 2×2/3×3, при необходимости debug-проходимость  

Читаемость сохраняется при юнитах, спеллах и подсветке.

---

## 9. Критерии готовности

- Сетка 18×32, координаты согласованы с world.
- Река блокирует проход; только 2 прохода — мосты.
- Игрок не может ставить на чужой половине, на воде, мостах, blocked.
- Footprint 3×3 и 2×2 корректно подсвечиваются и валидируются.
- Pathfinding стабильно ведёт к мостам и целям; здания обновляют проходимость.

---

## 10. Подготовка под ассеты

- Вода: отдельный слой/объект под анимацию (flow, shimmer).
- Мосты: отдельные спрайты с маской/тенью.
- Декор: система «edge decorations» без занятия геймплейных клеток.
- Переключатели: сетка, подсветка размещения, debug walkable/non-walkable.

Реализация: `lib/game/arena.ts`, отрисовка в `components/game/battle-canvas.tsx`.
